{
  "id": "snapshot_1764861365897_opf3c3itb",
  "approvalId": "approval_1764861058859_ym708tg9e",
  "approvalTitle": "Design Document: Agent System Refactoring",
  "version": 2,
  "timestamp": "2025-12-04T15:16:05.897Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document: Agent System Refactoring\r\n\r\n## Overview\r\n\r\nThis design document outlines the technical architecture for refactoring the KĀDI multi-agent orchestration system to eliminate code duplication through shared abstractions. The refactoring extracts 95-98% of duplicated logic from agent-artist, shadow-agent-artist, and agent-producer into a new `agents-library` package located at `C:\\p4\\Personal\\SD\\agents-library`.\r\n\r\nThe design introduces factory patterns, configuration-driven instantiation, and reusable utilities that enable creating new agents with minimal boilerplate (under 50 lines) while maintaining full backward compatibility with existing event-driven workflows.\r\n\r\n## Steering Document Alignment\r\n\r\n### Technical Standards (tech.md)\r\n\r\n*Note: No steering documents currently exist. This design follows established patterns from the existing codebase:*\r\n\r\n- **TypeScript with Strict Mode**: All code uses strict TypeScript (no `any` types)\r\n- **ES Modules**: Use `.js` extensions in imports, `\"type\": \"module\"` in package.json\r\n- **Zod for Validation**: Input validation uses Zod schemas\r\n- **@kadi.build/core**: KĀDI client library for broker communication\r\n- **Circuit Breaker Pattern**: Already implemented in BaseBot, will be reused\r\n- **Event-Driven Architecture**: KĀDI event topics follow pattern `{role}.{event_type}.{identifier}`\r\n\r\n### Project Structure (structure.md)\r\n\r\n*Note: No steering documents currently exist. This design proposes:*\r\n\r\n**New Package Location:**\r\n```\r\nC:\\p4\\Personal\\SD\\\r\n├── agents-library/           # NEW: Shared agent abstractions\r\n│   ├── src/\r\n│   │   ├── index.ts          # Public exports\r\n│   │   ├── base-bot.ts       # MOVED from AGENTS/shared\r\n│   │   ├── kadi-event-publisher.ts  # MOVED from AGENTS/shared\r\n│   │   ├── worker-agent-factory.ts  # NEW\r\n│   │   ├── shadow-agent-factory.ts  # NEW\r\n│   │   ├── producer-tool-utils.ts   # NEW\r\n│   │   └── types/            # NEW: Shared TypeScript interfaces\r\n│   ├── package.json\r\n│   └── tsconfig.json\r\n├── agent-artist/             # REFACTORED: Uses agents-library\r\n├── agent-designer/           # NEW: Uses agents-library\r\n├── agent-programmer/         # NEW: Uses agents-library\r\n├── shadow-agent-artist/      # REFACTORED: Uses agents-library\r\n└── agent-producer/           # REFACTORED: Uses agents-library utilities\r\n```\r\n\r\n## Code Reuse Analysis\r\n\r\n### Existing Components to Leverage\r\n\r\n**From `C:\\p4\\Personal\\SD\\AGENTS\\shared\\`** (will be moved to `agents-library`):\r\n\r\n1. **BaseBot (base-bot.ts)**\r\n   - **Purpose**: Abstract base class providing circuit breaker, retry logic, metrics tracking\r\n   - **How Used**: WorkerAgentFactory and ShadowAgentFactory will extend or compose with BaseBot\r\n   - **Key Features**:\r\n     - Circuit breaker with configurable max failures (default: 5)\r\n     - Exponential backoff retry logic\r\n     - Anthropic Claude API client integration\r\n     - KĀDI protocol tool invocation helpers\r\n\r\n2. **KadiEventPublisher (kadi-event-publisher.ts)**\r\n   - **Purpose**: Generic event publishing to KĀDI broker with graceful degradation\r\n   - **How Used**: Both worker and shadow factories will use this for event publishing\r\n   - **Key Features**:\r\n     - Connection management with retry\r\n     - Topic pattern validation: `{platform}.{event_type}.{bot_id}`\r\n     - Graceful degradation (stub mode if broker unavailable)\r\n\r\n3. **Dependencies from package.json**:\r\n   - `@anthropic-ai/sdk`: Claude API integration\r\n   - `@kadi.build/core`: KĀDI client library with KadiClient and Zod\r\n\r\n### Existing Patterns to Extract and Generalize\r\n\r\n**From `C:\\p4\\Personal\\SD\\agent-artist\\src\\index.ts` (868 lines):**\r\n\r\n1. **KĀDI Client Setup** (lines 1-200):\r\n   - Broker connection with configurable URL\r\n   - Network registration (global, artist)\r\n   - Tool registration (built-in + broker-provided)\r\n\r\n2. **Task Assignment Subscription** (lines 409-500):\r\n   - Subscribe to `{role}.task.assigned` events\r\n   - Parse task payload with Zod validation\r\n   - Handle invalid task format errors\r\n\r\n3. **Task Execution Workflow** (lines 500-700):\r\n   - Change directory to agent worktree\r\n   - Execute task using Claude API (streaming)\r\n   - Determine output filename with AI assistance\r\n   - Create/modify files in worktree\r\n   - Git add + commit with formatted message\r\n   - Publish completion event\r\n\r\n4. **Error Handling**:\r\n   - Try-catch wrappers around all operations\r\n   - Event publishing for failures\r\n   - Graceful degradation\r\n\r\n**From `C:\\p4\\Personal\\SD\\shadow-agent-artist\\src\\index.ts` (1,179 lines):**\r\n\r\n1. **Filesystem Watching** (lines 200-400):\r\n   - Chokidar setup for worktree monitoring\r\n   - Debouncing (1000ms delay)\r\n   - File operation type detection (add/change/unlink)\r\n\r\n2. **Git Ref Monitoring** (lines 400-600):\r\n   - Watch `.git/refs/heads/{branch}` file\r\n   - Detect commit SHA changes\r\n   - Trigger backup on new commits\r\n\r\n3. **Shadow Backup Logic** (lines 600-800):\r\n   - Parse git log for latest commit\r\n   - Read changed files from git diff\r\n   - Copy files to shadow worktree\r\n   - Create mirror commit with shadow prefix\r\n   - Circuit breaker for backup failures\r\n\r\n4. **Event Publishing**:\r\n   - `shadow-{role}.backup.completed`\r\n   - `shadow-{role}.backup.failed`\r\n\r\n**From `C:\\p4\\Personal\\SD\\agent-producer\\src\\tools\\plan-task.ts`:**\r\n\r\n1. **KĀDI Protocol Invocation**:\r\n   - Load protocol with `client.load()`\r\n   - Invoke tools via protocol\r\n   - Parse response with Zod validation\r\n\r\n2. **Option C Orchestration**:\r\n   - Multi-turn Claude API interactions\r\n   - Context accumulation across turns\r\n   - Tool result formatting for Claude\r\n\r\n3. **Event Publishing Pattern**:\r\n   - Construct event payload with timestamp\r\n   - Validate event schema\r\n   - Publish to topic\r\n\r\n### Integration Points\r\n\r\n**KĀDI Broker Integration:**\r\n- All agents connect to broker via WebSocket\r\n- Event subscription: `{role}.task.assigned`, `{role}.task.completed`, `{role}.task.failed`\r\n- Tool access: broker provides fs-mcp-server (global network), git-mcp-server (git network)\r\n\r\n**Git Worktree Integration:**\r\n- Each worker agent operates in separate worktree: `C:/p4/Personal/SD/agent-playground-{role}`\r\n- Shadow agents mirror worker worktrees\r\n- Commit messages must maintain format: `feat: create {type} for task {taskId}`\r\n\r\n**Slack/Discord Bot Integration:**\r\n- Bots already extend BaseBot\r\n- No changes needed to bot integration\r\n- Bots will continue using existing BaseBot methods\r\n\r\n## Architecture\r\n\r\n### Overall Architecture\r\n\r\nThe refactored system follows a **Factory + Strategy + Template Method** pattern:\r\n\r\n1. **Factory Pattern**: Instantiate worker/shadow agents with configuration\r\n2. **Strategy Pattern**: Role-specific behaviors injected as strategies\r\n3. **Template Method Pattern**: Shared workflows with customizable hooks\r\n4. **Dependency Injection**: Shared services (KĀDI client, Claude client) injected into factories\r\n\r\n```mermaid\r\ngraph TD\r\n    A[agents-library Package] --> B[WorkerAgentFactory]\r\n    A --> C[ShadowAgentFactory]\r\n    A --> D[ProducerToolUtils]\r\n    A --> E[BaseBot - Circuit Breaker]\r\n    A --> F[KadiEventPublisher]\r\n\r\n    B --> G[BaseWorkerAgent]\r\n    C --> H[BaseShadowAgent]\r\n\r\n    G --> I[agent-artist Instance]\r\n    G --> J[agent-designer Instance]\r\n    G --> K[agent-programmer Instance]\r\n\r\n    H --> L[shadow-agent-artist Instance]\r\n    H --> M[shadow-agent-designer Instance]\r\n    H --> N[shadow-agent-programmer Instance]\r\n\r\n    D --> O[agent-producer Tools]\r\n\r\n    I -.-> P[KĀDI Broker]\r\n    J -.-> P\r\n    K -.-> P\r\n    L -.-> P\r\n    M -.-> P\r\n    N -.-> P\r\n    O -.-> P\r\n```\r\n\r\n### Modular Design Principles\r\n\r\n1. **Single File Responsibility**:\r\n   - `worker-agent-factory.ts`: Only worker agent creation and lifecycle\r\n   - `shadow-agent-factory.ts`: Only shadow agent creation and monitoring\r\n   - `producer-tool-utils.ts`: Only tool invocation helpers\r\n\r\n2. **Component Isolation**:\r\n   - Each factory is independent and testable\r\n   - Configuration-driven (no hardcoded values)\r\n   - Dependency injection for external services\r\n\r\n3. **Service Layer Separation**:\r\n   - **Factory Layer**: Agent instantiation and configuration\r\n   - **Agent Layer**: Task execution and event handling\r\n   - **Utility Layer**: Reusable helpers (event publishing, tool invocation)\r\n\r\n4. **Utility Modularity**:\r\n   - Each utility function has single purpose\r\n   - Pure functions where possible\r\n   - Clear input/output contracts\r\n\r\n## Components and Interfaces\r\n\r\n### Component 1: WorkerAgentFactory\r\n\r\n**Purpose:** Create and manage worker agents (artist/designer/programmer) with minimal configuration\r\n\r\n**Interfaces:**\r\n\r\n```typescript\r\n// Configuration interface\r\ninterface WorkerAgentConfig {\r\n  role: string;                    // Agent role: 'artist', 'designer', 'programmer'\r\n  worktreePath: string;            // Git worktree path\r\n  brokerUrl: string;               // KĀDI broker WebSocket URL\r\n  networks: string[];              // KĀDI networks: ['global', role]\r\n  anthropicApiKey: string;         // Claude API key\r\n  claudeModel?: string;            // Optional: Claude model (default: 'claude-sonnet-4')\r\n  customBehaviors?: WorkerBehaviors;  // Optional: Role-specific overrides\r\n}\r\n\r\n// Strategy pattern for role-specific behaviors\r\ninterface WorkerBehaviors {\r\n  determineFilename?: (taskDescription: string, content: string) => Promise<string>;\r\n  formatCommitMessage?: (taskId: string, operation: string) => string;\r\n  preprocessTask?: (task: any) => Promise<any>;\r\n}\r\n\r\n// Public factory API\r\nclass WorkerAgentFactory {\r\n  static createAgent(config: WorkerAgentConfig): BaseWorkerAgent;\r\n}\r\n\r\n// Generated agent class (not directly instantiated)\r\nclass BaseWorkerAgent {\r\n  async start(): Promise<void>;\r\n  async stop(): Promise<void>;\r\n  protected async handleTaskAssignment(event: any): Promise<void>;\r\n  protected async executeTask(task: any): Promise<void>;\r\n  protected async publishCompletion(taskId: string, result: any): Promise<void>;\r\n}\r\n```\r\n\r\n**Dependencies:**\r\n- BaseBot (circuit breaker, retry logic)\r\n- KadiEventPublisher (event publishing)\r\n- @kadi.build/core (KadiClient)\r\n- @anthropic-ai/sdk (Claude API)\r\n- child_process (git operations)\r\n\r\n**Reuses:**\r\n- BaseBot.retryWithBackoff() for resilient operations\r\n- KadiEventPublisher.publishEvent() for event publishing\r\n- BaseBot circuit breaker state management\r\n\r\n### Component 2: ShadowAgentFactory\r\n\r\n**Purpose:** Create and manage shadow agents for backup and monitoring\r\n\r\n**Interfaces:**\r\n\r\n```typescript\r\n// Configuration interface\r\ninterface ShadowAgentConfig {\r\n  role: string;                    // Worker role to shadow: 'artist', 'designer', 'programmer'\r\n  workerWorktreePath: string;      // Worker git worktree path\r\n  shadowWorktreePath: string;      // Shadow git worktree path\r\n  workerBranch: string;            // Worker branch name (e.g., 'artist')\r\n  shadowBranch: string;            // Shadow branch name (e.g., 'shadow-artist')\r\n  brokerUrl: string;               // KĀDI broker WebSocket URL\r\n  networks: string[];              // KĀDI networks: ['global', 'shadow-{role}']\r\n  debounceMs?: number;             // Debounce delay (default: 1000ms)\r\n}\r\n\r\n// Public factory API\r\nclass ShadowAgentFactory {\r\n  static createAgent(config: ShadowAgentConfig): BaseShadowAgent;\r\n}\r\n\r\n// Generated shadow agent class\r\nclass BaseShadowAgent {\r\n  async start(): Promise<void>;\r\n  async stop(): Promise<void>;\r\n  protected async setupFilesystemWatcher(): Promise<void>;\r\n  protected async setupGitRefWatcher(): Promise<void>;\r\n  protected async createShadowBackup(): Promise<void>;\r\n  protected async publishBackupStatus(success: boolean, error?: Error): Promise<void>;\r\n}\r\n```\r\n\r\n**Dependencies:**\r\n- BaseBot (circuit breaker)\r\n- KadiEventPublisher (event publishing)\r\n- chokidar (filesystem watching)\r\n- @kadi.build/core (KadiClient)\r\n- child_process (git operations)\r\n- fs/promises (file operations)\r\n\r\n**Reuses:**\r\n- BaseBot circuit breaker for backup operation resilience\r\n- KadiEventPublisher for event publishing\r\n\r\n### Component 3: ProducerToolUtils\r\n\r\n**Purpose:** Shared utilities for agent-producer tool implementations\r\n\r\n**Interfaces:**\r\n\r\n```typescript\r\n// Tool invocation helper\r\ninterface ToolInvocationResult {\r\n  success: boolean;\r\n  result?: any;\r\n  error?: Error;\r\n}\r\n\r\nasync function invokeShrimTool(\r\n  client: KadiClient,\r\n  toolName: string,\r\n  args: any,\r\n  timeout: number = 30000\r\n): Promise<ToolInvocationResult>;\r\n\r\n// Option C orchestration helper\r\ninterface OrchestrationContext {\r\n  messages: any[];\r\n  toolResults: any[];\r\n}\r\n\r\nasync function orchestrateWithClaude(\r\n  anthropic: Anthropic,\r\n  systemPrompt: string,\r\n  userPrompt: string,\r\n  availableTools: any[],\r\n  maxTurns: number = 5\r\n): Promise<OrchestrationContext>;\r\n\r\n// Event publishing helper\r\ninterface ToolEventPayload {\r\n  timestamp: string;\r\n  agentName: string;\r\n  toolName: string;\r\n  status: 'started' | 'completed' | 'failed';\r\n  duration?: number;\r\n  error?: string;\r\n}\r\n\r\nasync function publishToolEvent(\r\n  publisher: KadiEventPublisher,\r\n  topic: string,\r\n  payload: ToolEventPayload\r\n): Promise<void>;\r\n\r\n// Error classification\r\nenum ErrorType {\r\n  Transient = 'transient',  // Retry-able (network, timeout)\r\n  Permanent = 'permanent'   // Non-retry-able (validation, not found)\r\n}\r\n\r\nfunction classifyToolError(error: Error): ErrorType;\r\n```\r\n\r\n**Dependencies:**\r\n- @kadi.build/core (KadiClient)\r\n- @anthropic-ai/sdk (Anthropic)\r\n- KadiEventPublisher\r\n\r\n**Reuses:**\r\n- Existing error handling patterns from agent-producer\r\n\r\n### Component 4: Shared Type Definitions\r\n\r\n**Purpose:** Common TypeScript interfaces for configuration and events\r\n\r\n**Interfaces:**\r\n\r\n```typescript\r\n// File: types/agent-config.ts\r\nexport interface AgentConfig {\r\n  type: 'worker' | 'shadow';\r\n  role: string;\r\n  paths: PathConfig;\r\n  broker: BrokerConfig;\r\n  behaviors?: any;\r\n}\r\n\r\nexport interface PathConfig {\r\n  worktree: string;\r\n  shadowWorktree?: string;  // Only for shadow agents\r\n}\r\n\r\nexport interface BrokerConfig {\r\n  url: string;\r\n  networks: string[];\r\n}\r\n\r\n// File: types/event-schemas.ts\r\nexport interface TaskAssignedEvent {\r\n  taskId: string;\r\n  role: string;\r\n  description: string;\r\n  requirements: string[];\r\n  timestamp: string;\r\n}\r\n\r\nexport interface TaskCompletedEvent {\r\n  taskId: string;\r\n  role: string;\r\n  result: {\r\n    filesCreated: string[];\r\n    filesModified: string[];\r\n    commitSha: string;\r\n  };\r\n  timestamp: string;\r\n}\r\n\r\nexport interface BackupEvent {\r\n  role: string;\r\n  operation: 'backup';\r\n  status: 'completed' | 'failed';\r\n  filesBackedUp?: string[];\r\n  error?: string;\r\n  timestamp: string;\r\n}\r\n\r\n// File: types/tool-schemas.ts\r\nexport interface ToolSchema {\r\n  name: string;\r\n  description: string;\r\n  input: any;   // Zod schema\r\n  output: any;  // Zod schema\r\n}\r\n```\r\n\r\n## Data Models\r\n\r\n### WorkerAgentConfig Model\r\n\r\nConfiguration for creating worker agents:\r\n\r\n```typescript\r\n{\r\n  role: string;              // Required: 'artist' | 'designer' | 'programmer'\r\n  worktreePath: string;      // Required: '/path/to/agent-playground-{role}'\r\n  brokerUrl: string;         // Required: 'ws://localhost:8080'\r\n  networks: string[];        // Required: ['global', role]\r\n  anthropicApiKey: string;   // Required: From environment\r\n  claudeModel: string;       // Optional: Default 'claude-sonnet-4'\r\n  customBehaviors: {         // Optional: Role-specific overrides\r\n    determineFilename?: Function;\r\n    formatCommitMessage?: Function;\r\n    preprocessTask?: Function;\r\n  };\r\n}\r\n```\r\n\r\n### ShadowAgentConfig Model\r\n\r\nConfiguration for creating shadow agents:\r\n\r\n```typescript\r\n{\r\n  role: string;                 // Required: Worker role to shadow\r\n  workerWorktreePath: string;   // Required: Worker worktree path\r\n  shadowWorktreePath: string;   // Required: Shadow worktree path\r\n  workerBranch: string;         // Required: 'artist' | 'designer' | 'programmer'\r\n  shadowBranch: string;         // Required: 'shadow-artist' | etc.\r\n  brokerUrl: string;            // Required: 'ws://localhost:8080'\r\n  networks: string[];           // Required: ['global', 'shadow-{role}']\r\n  debounceMs: number;           // Optional: Default 1000\r\n}\r\n```\r\n\r\n### TaskAssignedEvent Model\r\n\r\nEvent payload for task assignments:\r\n\r\n```typescript\r\n{\r\n  taskId: string;          // Unique task identifier\r\n  role: string;            // Target agent role\r\n  description: string;     // Task description\r\n  requirements: string[];  // Task requirements\r\n  timestamp: string;       // ISO 8601 timestamp\r\n}\r\n```\r\n\r\n### BackupEvent Model\r\n\r\nEvent payload for shadow backup status:\r\n\r\n```typescript\r\n{\r\n  role: string;                // Shadow agent role\r\n  operation: 'backup';         // Always 'backup'\r\n  status: 'completed' | 'failed';\r\n  filesBackedUp: string[];     // Files successfully backed up\r\n  error: string;               // Error message if failed\r\n  timestamp: string;           // ISO 8601 timestamp\r\n}\r\n```\r\n\r\n## Error Handling\r\n\r\n### Error Scenarios\r\n\r\n1. **Scenario: Worker agent task execution fails**\r\n   - **Handling:**\r\n     - Circuit breaker detects failure (BaseBot)\r\n     - Retry with exponential backoff (up to 3 attempts)\r\n     - If all retries fail, publish `{role}.task.failed` event\r\n     - Log detailed error with stack trace\r\n   - **User Impact:**\r\n     - agent-producer receives failure event\r\n     - Task can be reassigned to different agent\r\n     - No data loss (worktree remains intact)\r\n\r\n2. **Scenario: Shadow agent backup fails**\r\n   - **Handling:**\r\n     - Circuit breaker detects failure\r\n     - Do NOT retry immediately (wait for next file change)\r\n     - Publish `shadow-{role}.backup.failed` event\r\n     - Log error with file paths\r\n   - **User Impact:**\r\n     - Worker agent continues unaffected\r\n     - Shadow backup can be manually triggered\r\n     - No impact on primary workflow\r\n\r\n3. **Scenario: KĀDI broker disconnection**\r\n   - **Handling:**\r\n     - KadiEventPublisher enters stub mode\r\n     - Events are logged but not sent\r\n     - Automatic reconnection with exponential backoff\r\n     - Resume normal operation when reconnected\r\n   - **User Impact:**\r\n     - Agents continue processing local tasks\r\n     - Events queued in memory (up to limit)\r\n     - No crash or restart required\r\n\r\n4. **Scenario: Invalid task assignment payload**\r\n   - **Handling:**\r\n     - Zod validation detects schema mismatch\r\n     - Reject event without processing\r\n     - Publish `{role}.task.failed` with validation error\r\n     - Log validation details\r\n   - **User Impact:**\r\n     - Task not executed (prevents corrupt state)\r\n     - agent-producer notified of validation failure\r\n     - Allows fixing task format\r\n\r\n5. **Scenario: Git operation fails (commit, push)**\r\n   - **Handling:**\r\n     - Retry with backoff (up to 3 attempts)\r\n     - If retries fail, publish failure event\r\n     - Leave worktree in partially committed state\r\n     - Log git error output\r\n   - **User Impact:**\r\n     - Task marked as failed\r\n     - Manual git intervention may be needed\r\n     - Prevents silent data corruption\r\n\r\n6. **Scenario: Claude API rate limit**\r\n   - **Handling:**\r\n     - Detect 429 status code\r\n     - Exponential backoff with jitter\r\n     - Retry up to 5 times\r\n     - If all retries fail, mark task as failed\r\n   - **User Impact:**\r\n     - Task execution delayed but automatic\r\n     - No manual intervention needed\r\n     - Graceful degradation under high load\r\n\r\n## Testing Strategy\r\n\r\n### Unit Testing\r\n\r\n**Testing Framework:** Node.js built-in test runner (node:test) or Jest\r\n\r\n**Components to Test:**\r\n\r\n1. **WorkerAgentFactory**\r\n   - Test agent creation with valid config\r\n   - Test validation of required fields\r\n   - Test custom behavior injection\r\n   - Test default value assignment\r\n\r\n2. **ShadowAgentFactory**\r\n   - Test shadow agent creation\r\n   - Test debounce configuration\r\n   - Test path validation\r\n\r\n3. **ProducerToolUtils**\r\n   - Test invokeShrimTool with mock client\r\n   - Test error classification logic\r\n   - Test event payload construction\r\n   - Test timeout handling\r\n\r\n4. **Type Validation**\r\n   - Test Zod schemas for all configurations\r\n   - Test event schema validation\r\n   - Test invalid payload rejection\r\n\r\n**Mocking Strategy:**\r\n- Mock KadiClient for event publishing tests\r\n- Mock Anthropic client for Claude API tests\r\n- Mock chokidar for filesystem watching tests\r\n- Mock child_process.exec for git operation tests\r\n\r\n### Integration Testing\r\n\r\n**Testing Approach:** Docker Compose test environment with KĀDI broker\r\n\r\n**Key Flows to Test:**\r\n\r\n1. **End-to-End Worker Flow**\r\n   - Create worker agent with factory\r\n   - Publish task assignment event\r\n   - Verify task execution in worktree\r\n   - Verify completion event published\r\n   - Verify git commit created\r\n\r\n2. **End-to-End Shadow Flow**\r\n   - Create shadow agent with factory\r\n   - Trigger file change in worker worktree\r\n   - Verify shadow backup created\r\n   - Verify backup event published\r\n\r\n3. **Circuit Breaker Flow**\r\n   - Trigger repeated failures\r\n   - Verify circuit opens after max failures\r\n   - Verify automatic recovery after timeout\r\n\r\n4. **Broker Reconnection Flow**\r\n   - Start agent connected to broker\r\n   - Stop broker\r\n   - Verify graceful degradation\r\n   - Restart broker\r\n   - Verify automatic reconnection\r\n\r\n**Test Environment:**\r\n```yaml\r\n# docker-compose.test.yml\r\nservices:\r\n  kadi-broker:\r\n    image: kadi-broker:latest\r\n    ports:\r\n      - \"8080:8080\"\r\n\r\n  test-agent:\r\n    build: ./agents-library\r\n    depends_on:\r\n      - kadi-broker\r\n    environment:\r\n      KADI_BROKER_URL: ws://kadi-broker:8080\r\n      ANTHROPIC_API_KEY: test-key\r\n```\r\n\r\n### End-to-End Testing\r\n\r\n**Testing Approach:** Full system test with multiple agents\r\n\r\n**User Scenarios to Test:**\r\n\r\n1. **Multi-Agent Orchestration**\r\n   - Start agent-producer, agent-artist, agent-designer\r\n   - Produce task requiring multiple agents\r\n   - Verify task routing to correct agent\r\n   - Verify task completion from each agent\r\n\r\n2. **Shadow Agent Monitoring**\r\n   - Start worker and shadow agents\r\n   - Execute tasks in worker\r\n   - Verify shadow creates backups\r\n   - Verify shadow branch stays in sync\r\n\r\n3. **Failure Recovery**\r\n   - Trigger task failure in worker\r\n   - Verify failure event published\r\n   - Verify circuit breaker engages\r\n   - Verify recovery after cooldown\r\n\r\n4. **Hot Reload Configuration** (if implemented)\r\n   - Update agent configuration file\r\n   - Verify agent reloads without restart\r\n   - Verify new configuration applied\r\n\r\n**Acceptance Criteria:**\r\n- All tests pass with zero manual intervention\r\n- Test coverage greater than 80% for agents-library\r\n- No breaking changes to existing agents\r\n- Performance within 10% of current baseline\r\n",
  "fileStats": {
    "size": 22861,
    "lines": 711,
    "lastModified": "2025-12-04T15:10:51.315Z"
  },
  "comments": []
}