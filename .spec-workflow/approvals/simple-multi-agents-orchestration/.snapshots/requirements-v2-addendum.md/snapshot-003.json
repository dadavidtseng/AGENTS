{
  "id": "snapshot_1764502007067_q2wvzpx9v",
  "approvalId": "approval_1764501452419_9vvqqoobu",
  "approvalTitle": "Requirements V2 Addendum - Corrected with 6 User Feedbacks",
  "version": 3,
  "timestamp": "2025-11-30T11:26:47.067Z",
  "trigger": "revision_requested",
  "status": "pending",
  "content": "# Requirements V2: Architectural Corrections Addendum\r\n\r\n**Spec Name:** `simple-multi-agents-orchestration`\r\n**Original Date:** 2025-11-30\r\n**Revision:** V2-R1 (Revision 1) - 2025-11-30\r\n**Status:** Draft - Pending Approval\r\n**Type:** Architectural Corrections Addendum\r\n\r\n---\r\n\r\n## Purpose of This Document\r\n\r\nThis addendum corrects the original requirements.md based on deep codebase analysis and user feedback. All sections below SUPERSEDE the corresponding sections in the original requirements.md.\r\n\r\n**Critical Corrections Applied (User Feedback):**\r\n1. **Git Worktree Ownership**: Worker agents (artist/designer/programmer) create and manage their OWN worktrees - agent-producer does NOT create worktrees\r\n2. **Event Publishing**: agent-producer DOES publish custom KĀDI events for task distribution\r\n3. **MCP Server Path**: Correct path is `C:\\GitHub\\mcp-shrimp-task-manager`\r\n4. **Completion Workflow**: User verification → producer pushes to GitHub → publish cleanup events → workers remove worktrees\r\n5. **agent-producer Structure**: Already has discord-bot.ts and slack-bot.ts; does NOT extend BaseBot again\r\n6. **Network Naming**: Use \"programmer\" network (not \"development\")\r\n\r\n**Additional Key Changes:**\r\n7. MCP Server Naming: Use **mcp-shrimp-task-manager** (actual server name)\r\n8. Status Polling: Monitor via shrimp__list_tasks every 30s\r\n9. BaseBot Inheritance: Only worker agents extend BaseBot for resilience patterns\r\n10. MCP Upstream Configuration: Required broker configuration\r\n\r\n---\r\n\r\n## 1. Overview (SUPERSEDES Original Section 1)\r\n\r\n### 1.1 Purpose\r\n\r\nEnable **agent-producer** to act as an intelligent orchestrator that:\r\n- Receives user requests from multiple channels (Slack, Discord via existing bot integrations)\r\n- Breaks down work into structured tasks using **mcp-shrimp-task-manager** (accessed via KĀDI broker)\r\n- **Publishes task assignment events** via KĀDI broker for worker agents to subscribe\r\n- Monitors execution via **status polling** (shrimp__list_tasks every 30s)\r\n- Coordinates user verification and GitHub push\r\n- Notifies worker agents to cleanup worktrees after successful completion\r\n\r\n### 1.2 Architecture Foundation\r\n\r\n**KĀDI Broker Event-Driven Pattern:**\r\n```\r\nUser (Slack/Discord)\r\n    ↓ @mention\r\nmcp-client-slack/discord (MCP Server)\r\n    ↓ publishes event: slack.app_mention.* / discord.mention.*\r\nagent-producer (already has slack-bot.ts, discord-bot.ts)\r\n    ↓ subscribes to mention events\r\n    ↓ calls mcp-shrimp-task-manager tools via broker\r\n    ↓ PUBLISHES EVENT: agents.{worker}.tasks.assign\r\n    ↓\r\nWorker Agents (agent-artist, agent-designer, agent-programmer)\r\n    ↓ subscribe to agents.{agentId}.tasks.assign\r\n    ↓ CREATE THEIR OWN git worktrees (NOT created by producer)\r\n    ↓ execute tasks\r\n    ↓ log completion via mcp-shrimp-task-manager\r\n    ↓\r\nagent-producer\r\n    ↓ polls shrimp__list_tasks for status (every 30s)\r\n    ↓ requests user verification\r\n    ↓ AFTER USER APPROVAL: pushes to GitHub\r\n    ↓ PUBLISHES EVENT: agents.{worker}.tasks.cleanup\r\n    ↓\r\nWorker Agents\r\n    ↓ subscribe to agents.{agentId}.tasks.cleanup\r\n    ↓ remove their own git worktrees\r\n```\r\n\r\n**Communication Patterns:**\r\n- ✅ agent-producer **DOES publish** KĀDI events: `agents.{agentId}.tasks.assign`, `agents.{agentId}.tasks.cleanup`\r\n- ✅ Worker agents subscribe to: `agents.{agentId}.tasks.*`\r\n- ✅ Status monitoring via `shrimp__list_tasks` tool polling (every 30s)\r\n- ✅ All MCP tools accessed via `protocol.invokeTool()` through broker\r\n\r\n### 1.3 Goals\r\n\r\n- **G1:** Automate project decomposition via mcp-shrimp-task-manager tools\r\n- **G2:** Enable concurrent task execution with git worktree workspace isolation (managed by **worker agents**)\r\n- **G3:** Distribute tasks via **KĀDI event publishing** (agents.*.tasks.assign)\r\n- **G4:** Monitor execution via status polling (shrimp__list_tasks every 30s)\r\n- **G5:** Worker agents inherit resilience patterns from BaseBot (circuit breaker, retry logic)\r\n- **G6:** Handle failures gracefully with automatic reassignment\r\n\r\n---\r\n\r\n## 2. Critical Architecture Changes (NEW SECTION)\r\n\r\n### 2.1 MCP Server Integration via Broker\r\n\r\n**MCP Server Name:** `mcp-shrimp-task-manager`\r\n\r\n**Configuration File:** `C:\\p4\\Personal\\SD\\kadi\\kadi-broker\\config\\mcp-upstreams.json`\r\n\r\n**Required Entry:**\r\n```json\r\n{\r\n  \"upstreams\": [\r\n    {\r\n      \"id\": \"mcp-shrimp-task-manager\",\r\n      \"name\": \"mcp-shrimp-task-manager\",\r\n      \"description\": \"Task and spec management for agent playground\",\r\n      \"type\": \"stdio\",\r\n      \"prefix\": \"shrimp\",\r\n      \"enabled\": true,\r\n      \"stdio\": {\r\n        \"command\": \"node\",\r\n        \"args\": [\"C:\\\\GitHub\\\\mcp-shrimp-task-manager\\\\dist\\\\index.js\"],\r\n        \"env\": {\r\n          \"MCP_LOG_LEVEL\": \"info\"\r\n        }\r\n      },\r\n      \"networks\": [\"global\"],\r\n      \"retryPolicy\": {\r\n        \"maxAttempts\": 3,\r\n        \"initialBackoffMs\": 1000,\r\n        \"maxBackoffMs\": 10000,\r\n        \"backoffMultiplier\": 2\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\n### 2.2 Git Worktree Workspace Strategy\r\n\r\n**CRITICAL CORRECTION:** **Worker agents** create and manage their OWN worktrees. **agent-producer does NOT create worktrees.**\r\n\r\n**Base Playground Directory:**\r\n```\r\nC:\\p4\\Personal\\SD\\agent-playground\r\n```\r\n\r\n**Worker Agent Worktrees (created by worker agents themselves):**\r\n```\r\nC:\\p4\\Personal\\SD\\agent-playground-artist\r\nC:\\p4\\Personal\\SD\\agent-playground-designer\r\nC:\\p4\\Personal\\SD\\agent-playground-programmer\r\n```\r\n\r\n**Workflow:**\r\n\r\n1. **agent-producer: Task Planning and Event Publishing**\r\n   ```typescript\r\n   // 1. Call mcp-shrimp-task-manager to plan tasks\r\n   await protocol.invokeTool({\r\n     targetAgent: 'mcp-shrimp-task-manager',\r\n     toolName: 'shrimp__plan_task',\r\n     toolInput: { description: userRequest },\r\n     timeout: 30000\r\n   });\r\n\r\n   // 2. Publish task assignment event (event publishing, NOT tool invocation)\r\n   client.publishEvent(`agents.agent-artist.tasks.assign`, {\r\n     taskId: 'task-001',\r\n     description: 'Create design documentation',\r\n     basePlayground: 'C:\\\\p4\\\\Personal\\\\SD\\\\agent-playground',\r\n     baseBranch: 'main',\r\n     assignedAt: new Date().toISOString()\r\n   });\r\n   ```\r\n\r\n2. **Worker Agent: Worktree Creation and Task Execution**\r\n   ```typescript\r\n   // Worker agent subscribes to task assignment events\r\n   client.subscribeToEvent('agents.agent-artist.tasks.assign', async (event) => {\r\n     const { taskId, basePlayground, baseBranch } = event.data;\r\n\r\n     // Worker creates its OWN worktree\r\n     await this.invokeToolWithRetry({\r\n       targetAgent: 'mcp-server-git',\r\n       toolName: 'git__worktree',\r\n       toolInput: {\r\n         path: basePlayground,\r\n         mode: 'add',\r\n         worktreePath: 'C:\\\\p4\\\\Personal\\\\SD\\\\agent-playground-artist',\r\n         branch: `task-${taskId}`,\r\n         commitish: baseBranch\r\n       },\r\n       timeout: 10000\r\n     });\r\n\r\n     // Execute task\r\n     // Log completion via mcp-shrimp-task-manager\r\n   });\r\n   ```\r\n\r\n3. **agent-producer: User Verification and Git Push**\r\n   ```typescript\r\n   // Poll for task completion\r\n   const statusResult = await protocol.invokeTool({\r\n     targetAgent: 'mcp-shrimp-task-manager',\r\n     toolName: 'shrimp__list_tasks',\r\n     toolInput: { status: 'completed' },\r\n     timeout: 30000\r\n   });\r\n\r\n   // Request user verification\r\n   await sendMessageToUser('All tasks complete. Please review and verify.');\r\n\r\n   // AFTER USER APPROVAL: Push to GitHub\r\n   await protocol.invokeTool({\r\n     targetAgent: 'mcp-server-git',\r\n     toolName: 'git__push',\r\n     toolInput: {\r\n       path: 'C:\\\\p4\\\\Personal\\\\SD\\\\agent-playground',\r\n       remote: 'origin',\r\n       branch: 'main'\r\n     },\r\n     timeout: 30000\r\n   });\r\n\r\n   // Publish cleanup event\r\n   client.publishEvent('agents.agent-artist.tasks.cleanup', {\r\n     taskId: 'task-001'\r\n   });\r\n   ```\r\n\r\n4. **Worker Agent: Worktree Cleanup**\r\n   ```typescript\r\n   // Subscribe to cleanup events\r\n   client.subscribeToEvent('agents.agent-artist.tasks.cleanup', async (event) => {\r\n     // Worker removes its OWN worktree\r\n     await this.invokeToolWithRetry({\r\n       targetAgent: 'mcp-server-git',\r\n       toolName: 'git__worktree',\r\n       toolInput: {\r\n         path: 'C:\\\\p4\\\\Personal\\\\SD\\\\agent-playground',\r\n         mode: 'remove',\r\n         worktreePath: 'C:\\\\p4\\\\Personal\\\\SD\\\\agent-playground-artist',\r\n         force: true\r\n       },\r\n       timeout: 10000\r\n     });\r\n   });\r\n   ```\r\n\r\n### 2.3 agent-producer Architecture (EXISTING STRUCTURE)\r\n\r\n**CRITICAL CORRECTION:** agent-producer **already has** discord-bot.ts and slack-bot.ts. It **does NOT extend BaseBot again**.\r\n\r\n**Existing Implementation:**\r\n- SlackBot and DiscordBot already extend BaseBot\r\n- agent-producer uses KadiClient directly\r\n- Orchestration logic added to agent-producer as regular methods/functions\r\n- **Networks:** `['global', 'text', 'git', 'slack', 'discord', 'programmer', 'design']`\r\n\r\n### 2.4 Worker Agent BaseBot Inheritance Pattern\r\n\r\n**Worker Agents (agent-artist, agent-designer, agent-programmer) extend BaseBot:**\r\n\r\n```typescript\r\nimport { BaseBot, BaseBotConfig } from '@agents/shared';\r\n\r\nexport class ArtistAgent extends BaseBot {\r\n  async start(): Promise<void> {\r\n    this.initializeProtocol();\r\n\r\n    // Subscribe to task assignment events\r\n    this.client.subscribeToEvent('agents.agent-artist.tasks.assign', async (event) => {\r\n      await this.handleTaskAssignment(event);\r\n    });\r\n\r\n    // Subscribe to cleanup events\r\n    this.client.subscribeToEvent('agents.agent-artist.tasks.cleanup', async (event) => {\r\n      await this.handleCleanup(event);\r\n    });\r\n  }\r\n}\r\n```\r\n\r\n**Inherited Capabilities (from BaseBot):**\r\n- Circuit Breaker: Opens after 5 failures, resets after 60s\r\n- Retry Logic: Exponential backoff (1s, 2s, 4s) up to 3 attempts\r\n- Metrics Tracking\r\n\r\n### 2.5 Network Names (CORRECTED)\r\n\r\n- ✅ Use **\"programmer\"** network (NOT \"development\")\r\n- ✅ Use \"design\" network for design agents\r\n- ✅ Use \"global\" network for all agents\r\n\r\n---\r\n\r\n## 3. Completion Workflow (CORRECTED)\r\n\r\n**Complete Workflow:**\r\n\r\n1. **Task Execution:** Worker agents complete tasks and log via shrimp__log_implementation\r\n2. **Status Monitoring:** agent-producer polls shrimp__list_tasks every 30s\r\n3. **User Verification:** agent-producer requests user to review completed work\r\n4. **User Approval:** User verifies work is acceptable\r\n5. **Git Push:** **agent-producer** pushes to remote GitHub repository\r\n6. **Cleanup Event:** agent-producer publishes agents.{worker}.tasks.cleanup events\r\n7. **Worktree Removal:** **Worker agents** remove their own git worktrees\r\n\r\n**Corrected Success Path:**\r\n```\r\nComplete Tasks → Poll Status → Request User Verification → User Approves\r\n→ Producer Pushes to GitHub → Publish Cleanup Events → Workers Remove Worktrees\r\n```\r\n\r\n---\r\n\r\n## 4. Summary of Critical Corrections\r\n\r\n1. ✅ **Git Worktree Creation:** Worker agents create their OWN worktrees (NOT agent-producer)\r\n2. ✅ **Event Publishing:** agent-producer DOES publish custom KĀDI events (agents.*.tasks.*)\r\n3. ✅ **MCP Server Path:** C:\\GitHub\\mcp-shrimp-task-manager\r\n4. ✅ **Completion Workflow:** User verify → producer push to GitHub → publish cleanup event → workers remove worktrees\r\n5. ✅ **agent-producer Structure:** Already has discord-bot.ts and slack-bot.ts; does NOT extend BaseBot again\r\n6. ✅ **Network Name:** \"programmer\" network (NOT \"development\")\r\n\r\n---\r\n\r\n## Next Steps\r\n\r\n1. Update full requirements.md with these architectural patterns\r\n2. Request new approval after corrections\r\n3. Proceed to design phase after approval\r\n",
  "fileStats": {
    "size": 11630,
    "lines": 324,
    "lastModified": "2025-11-30T11:17:12.604Z"
  },
  "comments": []
}