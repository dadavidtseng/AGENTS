{
  "id": "snapshot_1764498431705_xfwlqsymu",
  "approvalId": "approval_1764498202848_1w5qrzs5l",
  "approvalTitle": "Architectural Updates - Multi-Agent Orchestration (Based on Codebase Analysis)",
  "version": 2,
  "timestamp": "2025-11-30T10:27:11.704Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Architectural Updates for Simple Multi-Agent Orchestration\n\n**Date:** 2025-11-30\n**Based on:** Deep codebase analysis of K\\u0100DI/MCP architecture\n\n---\n\n## Key Changes from Original Requirements\n\n### 1. MCP Server Naming\n- **OLD:** shrimp-AGENTS MCP server\n- **NEW:** shrimp-agent-playground MCP server  \n- **Reason:** Avoid namespace confusion with @agents/* packages\n\n### 2. Integration Pattern Changes\n\n#### Original Design (INCORRECT):\n- Direct event publishing to KĀDI topics like `agents.{target}.tasks.assign`\n- Manual agent registry maintenance\n- Custom heartbeat protocol\n\n#### Correct Architecture (FROM CODEBASE):\n- **All MCP servers accessed via KĀDI broker as \"MCP upstreams\"**\n- **No manual registry**: Use `protocol.discoverAgents()` from broker\n- **No custom events**: Use `protocol.invokeTool()` for all agent communication\n- **Status polling** instead of heartbeats: Call `shrimp__list_tasks` every 30s\n\n### 3. Git Worktree Strategy (NEW)\n\n**Base Playground:**\n```\nC:/p4/Personal/SD/agent-playground\n```\n\n**Agent Worktrees:**\n```\nC:/p4/Personal/SD/agent-playground-artist\nC:/p4/Personal/SD/agent-playground-designer\nC:/p4/Personal/SD/agent-playground-programmer\n```\n\n**Management:**\n- Create via `git__worktree` tool (mode: add)\n- Cleanup via `git__worktree` tool (mode: remove)\n- Tool accessed via: `protocol.invokeTool({ targetAgent: \"mcp-server-git\", toolName: \"git__worktree\", ... })`\n\n### 4. MCP Upstream Configuration (REQUIRED)\n\n**File:** `kadi-broker/config/mcp-upstreams.json`\n\n**Must Add:**\n```json\n{\n  \"id\": \"shrimp-agent-playground\",\n  \"name\": \"shrimp-agent-playground\",\n  \"description\": \"Task and spec management for agent playground\",\n  \"type\": \"stdio\",\n  \"prefix\": \"shrimp\",\n  \"enabled\": true,\n  \"stdio\": {\n    \"command\": \"node\",\n    \"args\": [\"C:/p4/Personal/SD/shrimp-agent-playground/dist/index.js\"],\n    \"env\": { \"MCP_LOG_LEVEL\": \"info\" }\n  },\n  \"networks\": [\"global\"],\n  \"retryPolicy\": {\n    \"maxAttempts\": 3,\n    \"initialBackoffMs\": 1000,\n    \"maxBackoffMs\": 10000,\n    \"backoffMultiplier\": 2\n  }\n}\n```\n\n### 5. Tool Invocation Pattern (FROM BaseBot)\n\n**Inherit from BaseBot:**\n```typescript\nimport { BaseBot, BaseBotConfig } from '@agents/shared';\n\nexport class ProducerAgent extends BaseBot {\n  constructor(config: BaseBotConfig) {\n    super(config);\n  }\n  \n  async start() {\n    // Initialize protocol FIRST\n    this.initializeProtocol();\n    \n    // Then use it for tool calls\n    const result = await this.invokeToolWithRetry({\n      targetAgent: 'shrimp-agent-playground',\n      toolName: 'shrimp__plan_task',\n      toolInput: { description: 'user request...' },\n      timeout: 30000\n    });\n  }\n}\n```\n\n**Benefits:**\n- Circuit breaker (5 failures → open 60s, auto-reset)\n- Retry logic (1s, 2s, 4s backoff, 3 attempts)\n- Metrics tracking (`getMetrics()`)\n\n### 6. Agent Discovery (FROM KadiClient)\n\n**NO Manual Registry Needed:**\n```typescript\n// Get all connected agents and their tools\nconst agents = await this.protocol.discoverAgents();\n\n// Result format:\n// {\n//   agentId: \"agent-artist\",\n//   tools: [\n//     { name: \"create_design_doc\", description: \"...\" },\n//     { name: \"generate_wireframes\", description: \"...\" }\n//   ],\n//   networks: [\"global\", \"design\"]\n// }\n\n// Infer capabilities from tool names\nconst hasDesignCapability = agents.some(a => \n  a.tools.some(t => t.name.includes('design'))\n);\n```\n\n### 7. Messaging Pattern (FROM mcp-server-slack/discord)\n\n**Slack Reply:**\n```typescript\nawait this.invokeToolWithRetry({\n  targetAgent: 'mcp-server-slack',\n  toolName: 'send_reply',\n  toolInput: {\n    channel: 'C12345',\n    thread_ts: '1234567890.123456',\n    text: '✅ Task 1/5 complete: Design doc created'\n  },\n  timeout: 10000\n});\n```\n\n**Discord Reply:**\n```typescript\nawait this.invokeToolWithRetry({\n  targetAgent: 'mcp-server-discord',\n  toolName: 'send_reply',\n  toolInput: {\n    channel: '1234567890',\n    message_id: '9876543210',\n    text: '✅ Task 1/5 complete: Design doc created'\n  },\n  timeout: 10000\n});\n```\n\n### 8. Worker Agent Requirements (USER CREATES THESE)\n\n**Agent Names (examples):**\n- agent-artist\n- agent-programmer\n- agent-designer\n\n**Each Must:**\n1. Extend BaseBot from @agents/shared\n2. Register tools on startup: `client.registerTool({ name, description, input, output }, handler)`\n3. Accept `execute_task` tool invocations with workspace parameter\n4. Call shrimp-agent-playground tools via broker for logging: `shrimp__log_implementation`\n\n**Example:**\n```typescript\nexport class ArtistAgent extends BaseBot {\n  async start() {\n    this.initializeProtocol();\n    \n    // Register capabilities\n    this.client.registerTool({\n      name: 'create_design_doc',\n      description: 'Create design documentation',\n      input: z.object({ /* ... */ }),\n      output: z.object({ /* ... */ })\n    }, async (params) => {\n      // Implementation...\n      \n      // Log to shrimp-agent-playground\n      await this.invokeToolWithRetry({\n        targetAgent: 'shrimp-agent-playground',\n        toolName: 'shrimp__log_implementation',\n        toolInput: {\n          taskId: params.taskId,\n          summary: '...',\n          artifacts: { /* ... */ },\n          filesModified: [...],\n          filesCreated: [...]\n        },\n        timeout: 30000\n      });\n      \n      return { success: true };\n    });\n  }\n}\n```\n\n---\n\n## Summary of Critical Fixes\n\n1. ✅ **Rename**: shrimp-AGENTS → shrimp-agent-playground\n2. ✅ **No Custom Events**: Use `protocol.invokeTool()` instead of publishing to `agents.*.tasks.*` topics\n3. ✅ **No Heartbeats**: Use status polling via `shrimp__list_tasks` every 30s\n4. ✅ **Git Worktrees**: Create isolated workspaces before task assignment\n5. ✅ **BaseBot Inheritance**: Get circuit breaker + retry logic for free\n6. ✅ **Agent Discovery**: Use `protocol.discoverAgents()` instead of manual registry\n7. ✅ **MCP Upstream Config**: Must add shrimp-agent-playground to broker config\n8. ✅ **Worker Agents**: User will create agent-artist, agent-programmer, agent-designer\n\n---\n\n**Next Steps:**\n1. Update full requirements.md with these architectural patterns\n2. Request new approval\n3. Proceed to design phase after approval\n",
  "fileStats": {
    "size": 6143,
    "lines": 226,
    "lastModified": "2025-11-30T10:22:58.796Z"
  },
  "comments": []
}