{
  "id": "snapshot_1766537897401_37dmmmkns",
  "approvalId": "approval_1766537897385_ocyxf3ceh",
  "approvalTitle": "Requirements Document for 7 KADI Abilities Integration",
  "version": 1,
  "timestamp": "2025-12-24T00:58:17.401Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements Document\n\n## Introduction\n\nThis feature integrates seven existing KADI abilities into the template-agent-typescript codebase, replacing custom implementations with standardized, reusable KADI ability services. The integration will transform the agent from a monolithic architecture to a distributed, service-oriented architecture using KADI's broker-mediated tool invocation pattern.\n\nThe seven abilities to integrate are:\n1. **kadi-tunnel-ability** - Self-hosted enterprise tunneling with Let's Encrypt\n2. **local-remote-file-manager-ability** - Local file operations + S3 serving + tunneling\n3. **arcadedb-ability** - Docker container management for ArcadeDB\n4. **cloud-file-manager-ability** - Dropbox/Google Drive/Box integration\n5. **container-registry-ability** - OCI-compliant container registry operations\n6. **deploy-ability** - Akash Network + Docker deployment orchestration\n7. **file-management-ability** - SSH/SCP remote server operations\n\nThis integration will eliminate code duplication, improve maintainability, and enable the agent to leverage battle-tested external services that can be scaled independently.\n\n## Alignment with Product Vision\n\nThis feature aligns with KADI's core architectural principle of separating agents (AI orchestration) from abilities (I/O operations). By moving file management, deployment, and infrastructure operations into dedicated ability services, the template-agent can focus purely on AI-driven task orchestration while delegating operational concerns to specialized, reusable services.\n\nThis supports:\n- **Modularity**: Each ability can be developed, tested, and scaled independently\n- **Network Isolation**: Abilities are only visible to agents in shared networks\n- **Event-Driven Architecture**: Real-time progress updates via pub/sub\n- **Zero-Trust Security**: Ed25519 authentication for all broker connections\n\n## Requirements\n\n### Requirement 1: Wrap Existing Abilities as KADI Services\n\n**User Story:** As a KADI developer, I want all 7 abilities to connect to the KADI broker, so that template-agent can invoke their tools via broker-mediated protocol.\n\n#### Acceptance Criteria\n\n1. WHEN each ability starts THEN it SHALL connect to KADI broker using KadiClient with `role: 'ability'`\n2. WHEN each ability connects THEN it SHALL register all its tools using `client.registerTool()`\n3. WHEN each ability registers THEN it SHALL specify appropriate networks (e.g., 'global', 'file-ops', 'deployment')\n4. WHEN each ability is ready THEN it SHALL call `client.serve()` to listen for tool invocations\n5. WHEN an ability receives a tool invocation THEN it SHALL execute the tool and return results via JSON-RPC 2.0 protocol\n6. IF an ability performs long operations THEN it SHALL emit progress events using `client.publishEvent()`\n\n### Requirement 2: Fix Template Agent Broker Configuration\n\n**User Story:** As a template-agent developer, I want the agent to properly connect to KADI broker, so that it can invoke ability tools.\n\n#### Acceptance Criteria\n\n1. WHEN agent initializes THEN it SHALL use `brokers: { default: brokerUrl }` parameter (NOT `broker`)\n2. WHEN agent initializes THEN it SHALL specify `transport: 'broker'` explicitly\n3. WHEN agent initializes THEN it SHALL specify `defaultBroker: 'default'`\n4. WHEN agent connects to broker THEN it SHALL authenticate using Ed25519 signature\n5. WHEN agent is authenticated THEN it SHALL register its networks correctly\n\n### Requirement 3: Load Abilities from Template Agent\n\n**User Story:** As a template-agent, I want to load all 7 abilities on startup, so that I can invoke their tools during task execution.\n\n#### Acceptance Criteria\n\n1. WHEN agent finishes broker connection THEN it SHALL load all 7 abilities using `client.loadAbility(name, 'broker')`\n2. WHEN loading abilities THEN it SHALL subscribe to relevant events (e.g., 'deploy.progress', 'file-manager.upload-progress')\n3. WHEN ability loading fails THEN agent SHALL log error and attempt retry\n4. WHEN all abilities are loaded THEN agent SHALL store ability proxies for use in task handlers\n5. IF ability is not available THEN agent SHALL continue with reduced functionality\n\n### Requirement 4: Replace File Management Implementation\n\n**User Story:** As a template-agent developer, I want to remove custom file management code, so that file operations are handled by dedicated abilities.\n\n#### Acceptance Criteria\n\n1. WHEN integration is complete THEN `src/file-management/file-manager-proxy.ts` SHALL be deleted\n2. WHEN file operations are needed THEN agent SHALL call `file-management-ability` for SSH/SCP operations\n3. WHEN local file serving is needed THEN agent SHALL call `local-remote-file-manager-ability`\n4. WHEN cloud storage is needed THEN agent SHALL call `cloud-file-manager-ability`\n5. WHEN agent calls file abilities THEN it SHALL use ability proxy pattern (not direct protocol.invokeTool)\n\n### Requirement 5: Replace Deployment Implementation\n\n**User Story:** As a template-agent developer, I want to remove custom deployment code, so that deployments are handled by deploy-ability.\n\n#### Acceptance Criteria\n\n1. WHEN integration is complete THEN `src/deployment/deploy-service.ts` SHALL be deleted\n2. WHEN integration is complete THEN `src/deployment/types.ts` SHALL be deleted\n3. WHEN deployment is needed THEN agent SHALL call `deploy-ability` tools\n4. WHEN deployment starts THEN agent SHALL listen for 'deploy.progress' events\n5. WHEN deployment completes THEN agent SHALL receive deployment details (gatewayUrl, apiKey, status)\n\n### Requirement 6: Integrate Tunneling Capability\n\n**User Story:** As a template-agent, I want to create secure tunnels for local services, so that they are accessible over the internet.\n\n#### Acceptance Criteria\n\n1. WHEN agent needs to expose a local service THEN it SHALL invoke `kadi-tunnel-ability` create_tunnel tool\n2. WHEN tunnel is created THEN agent SHALL receive subdomain and public URL\n3. WHEN agent has choice between tunneling solutions THEN it SHALL prefer `kadi-tunnel-ability` (self-hosted) over `local-remote-file-manager-ability` (3rd party ngrok/serveo)\n4. WHEN tunnel is no longer needed THEN agent SHALL destroy tunnel using destroy_tunnel tool\n\n### Requirement 7: Integrate Container Registry Operations\n\n**User Story:** As a template-agent, I want to push/pull container images, so that I can deploy containerized applications.\n\n#### Acceptance Criteria\n\n1. WHEN agent needs to push a container image THEN it SHALL invoke `container-registry-ability` push_image tool\n2. WHEN agent needs to pull a container image THEN it SHALL invoke pull_image tool\n3. WHEN agent needs to list available images THEN it SHALL invoke list_images tool\n4. WHEN registry operations fail THEN agent SHALL receive detailed error messages\n\n### Requirement 8: Integrate ArcadeDB Container Management\n\n**User Story:** As a template-agent developer, I want to manage ArcadeDB containers, so that the agent can start/stop database instances.\n\n#### Acceptance Criteria\n\n1. WHEN agent needs to start ArcadeDB THEN it SHALL invoke `arcadedb-ability` start_container tool\n2. WHEN agent needs to stop ArcadeDB THEN it SHALL invoke stop_container tool\n3. WHEN agent needs to backup database THEN it SHALL invoke backup_database tool\n4. WHEN agent performs queries THEN it SHALL continue using `src/memory/arcadedb-adapter.ts` (NOT the ability)\n5. IF arcadedb-ability is unavailable THEN agent SHALL still function with existing adapter\n\n### Requirement 9: Event Subscription and Monitoring\n\n**User Story:** As a template-agent, I want to receive real-time progress updates from abilities, so that I can track long-running operations.\n\n#### Acceptance Criteria\n\n1. WHEN agent loads abilities THEN it SHALL subscribe to all relevant progress events\n2. WHEN 'deploy.progress' event is received THEN agent SHALL log deployment stage and message\n3. WHEN 'file-manager.upload-progress' event is received THEN agent SHALL log upload percentage\n4. WHEN 'deploy.completed' event is received THEN agent SHALL store deployment details\n5. WHEN 'deploy.failed' event is received THEN agent SHALL handle error appropriately\n\n### Requirement 10: Ability Discovery and Documentation\n\n**User Story:** As a template-agent developer, I want to know which tools are available from each ability, so that I can use them correctly.\n\n#### Acceptance Criteria\n\n1. WHEN each ability starts THEN it SHALL have an `agent.json` manifest describing its tools\n2. WHEN developer needs tool documentation THEN each ability SHALL have clear JSDoc/TypeDoc comments\n3. WHEN agent calls a tool THEN it SHALL follow the tool's input schema exactly\n4. WHEN tool invocation fails THEN error message SHALL clearly identify which ability and tool failed\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n\n- **Single Responsibility Principle**: Each ability handles one domain (files, deployment, databases, etc.)\n- **Modular Design**: Abilities are independent services that can be started/stopped without affecting others\n- **Dependency Management**: Template-agent depends on abilities via broker protocol, not direct imports\n- **Clear Interfaces**: Each ability exposes tools via JSON-RPC 2.0 with explicit input/output schemas\n\n### Performance\n\n- **Tool Invocation Latency**: Broker-mediated tool calls SHALL complete within 100ms overhead (excluding actual work)\n- **Concurrent Operations**: Agent SHALL support parallel ability tool calls when operations are independent\n- **Event Delivery**: Progress events SHALL be delivered within 50ms of emission\n- **Ability Startup Time**: Each ability SHALL connect to broker within 5 seconds\n\n### Security\n\n- **Authentication**: All broker connections SHALL use Ed25519 signature authentication\n- **Network Isolation**: Tools SHALL only be visible to agents/abilities in shared networks\n- **Secret Management**: API keys and credentials SHALL be passed via environment variables, not hardcoded\n- **Audit Trail**: All tool invocations SHALL be logged for security auditing\n\n### Reliability\n\n- **Graceful Degradation**: If an ability is unavailable, agent SHALL continue with reduced functionality\n- **Retry Logic**: Tool invocations SHALL retry up to 3 times with exponential backoff on transient failures\n- **Error Handling**: Ability errors SHALL be propagated to agent with clear error messages\n- **Health Monitoring**: Abilities SHALL expose health check endpoints for monitoring\n\n### Usability\n\n- **Clear Logging**: All tool invocations and events SHALL be logged with timestamps and context\n- **Progress Visibility**: Long-running operations SHALL emit progress events at meaningful intervals\n- **Documentation**: Each ability SHALL have comprehensive README with usage examples\n- **Developer Experience**: Ability proxy pattern SHALL provide autocomplete and type safety\n",
  "fileStats": {
    "size": 10835,
    "lines": 184,
    "lastModified": "2025-12-24T00:58:07.153Z"
  },
  "comments": []
}