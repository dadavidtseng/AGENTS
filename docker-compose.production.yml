version: '3.8'

# ============================================================================
# KADI System - Production Docker Compose Configuration
# ============================================================================
# Deploys all 6 services + RabbitMQ to DigitalOcean Droplet
# Target: napoftheearth (64.23.168.129)
#
# Services:
# - rabbit: RabbitMQ message queue (required by broker)
# - kadi-broker: Main orchestration hub with MCP upstream management
# - agent: Agent_TypeScript (coordinates bots, text processing)
# - mcp-slack-client: Listens for Slack @mentions
# - mcp-slack-server: Sends Slack messages
# - mcp-discord-client: Listens for Discord @mentions
# - mcp-discord-server: Sends Discord messages
# ============================================================================

networks:
  kadi-net:
    driver: bridge

volumes:
  rabbitmq-data:
    driver: local

services:
  # ==========================================================================
  # RabbitMQ - Message Queue
  # ==========================================================================
  rabbit:
    image: rabbitmq:4-management
    container_name: kadi-rabbit
    restart: unless-stopped
    ports:
      - "5672:5672"      # AMQP protocol
      - "15672:15672"    # Management UI
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    networks:
      - kadi-net
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest

  # ==========================================================================
  # KADI Broker - Main Orchestration Hub
  # ==========================================================================
  kadi-broker:
    build:
      context: ./kadi/kadi-broker
      dockerfile: Dockerfile.production
    container_name: kadi-broker
    restart: unless-stopped
    depends_on:
      rabbit:
        condition: service_healthy
    ports:
      - "8080:8080"      # WebSocket + HTTP API
    networks:
      - kadi-net
    volumes:
      # Mount config directory for mcp-upstreams.json
      - ./kadi/kadi-broker/config:/app/config:ro
      # Mount MCP server complete directories (broker spawns them as child processes)
      - ./MCP_Slack_Client:/app/mcp/slack-client:ro
      - ./MCP_Slack_Server:/app/mcp/slack-server:ro
      - ./MCP_Discord_Client:/app/mcp/discord-client:ro
      - ./MCP_Discord_Server:/app/mcp/discord-server:ro
    env_file:
      - .env.production
    environment:
      - AMQP_URL=amqp://rabbit:5672
      - WS_PORT=8080
      - NODE_ENV=production
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s

  # ==========================================================================
  # Agent_TypeScript - Bot Coordinator & Text Processor
  # ==========================================================================
  agent:
    build:
      context: .
      dockerfile: ./Agent_TypeScript/Dockerfile.production
    container_name: kadi-agent
    restart: unless-stopped
    depends_on:
      kadi-broker:
        condition: service_healthy
    networks:
      - kadi-net
    env_file:
      - .env.production
    environment:
      - KADI_BROKER_URL=ws://kadi-broker:8080/kadi
      - ENABLE_SLACK_BOT=true
      - ENABLE_DISCORD_BOT=true
      - BOT_POLL_INTERVAL_MS=5000
      - NODE_ENV=production
      - KADI_DEBUG=true

  # ==========================================================================
  # MCP Slack Client - Listens for @mentions (spawned by broker)
  # ==========================================================================
  # Note: This service is spawned as a child process by kadi-broker
  # The dist directory is mounted into broker container at /app/mcp/slack-client
  # Configuration is in kadi-broker/config/mcp-upstreams.json

  # ==========================================================================
  # MCP Slack Server - Sends messages (spawned by broker)
  # ==========================================================================
  # Note: This service is spawned as a child process by kadi-broker
  # The dist directory is mounted into broker container at /app/mcp/slack-server
  # Configuration is in kadi-broker/config/mcp-upstreams.json

  # ==========================================================================
  # MCP Discord Client - Listens for @mentions (spawned by broker)
  # ==========================================================================
  # Note: This service is spawned as a child process by kadi-broker
  # The dist directory is mounted into broker container at /app/mcp/discord-client
  # Configuration is in kadi-broker/config/mcp-upstreams.json

  # ==========================================================================
  # MCP Discord Server - Sends messages (spawned by broker)
  # ==========================================================================
  # Note: This service is spawned as a child process by kadi-broker
  # The dist directory is mounted into broker container at /app/mcp/discord-server
  # Configuration is in kadi-broker/config/mcp-upstreams.json
