# ============================================================================
# Template Agent TypeScript - Test Deployment Dockerfile
# ============================================================================
# Strategy:
# - @kadi.build/core: Use published npm package (0.0.1-alpha.15)
# - agents-library: Create proper npm-installable package structure
# - Uses pre-built dist/ directory - skips TypeScript compilation
# ============================================================================

FROM node:20-alpine

WORKDIR /app

# Copy template-agent package.json and modify it to use npm @kadi.build/core
COPY template-agent-typescript/package.json ./package.json.orig
RUN sed 's|"@kadi.build/core": "file:../kadi/kadi-core"|"@kadi.build/core": "0.0.1-alpha.15"|' \
    package.json.orig | \
    sed 's|"agents-library": "file:../agents-library"|"agents-library": "file:./local-packages/agents-library"|' \
    > package.json && \
    rm package.json.orig

# Skip package-lock.json - it contains local development paths that won't work in Docker

# Create local packages directory and copy agents-library
RUN mkdir -p ./local-packages
COPY agents-library ./local-packages/agents-library

# Patch agents-library package.json to use correct @kadi.build/core version
RUN sed -i 's|"@kadi.build/core": "\^0.1.24"|"@kadi.build/core": "0.0.1-alpha.15"|' \
    ./local-packages/agents-library/package.json

# Install all dependencies (this will properly install agents-library as a file: dependency)
RUN npm install --omit=dev

# Copy pre-built dist directory
COPY template-agent-typescript/dist ./dist

# Fix ESM directory import issue - Node.js ESM requires explicit index.js
RUN sed -i "s|from './tools'|from './tools/index.js'|g" ./dist/index.js

# Create memory data directory with proper permissions
RUN mkdir -p /app/data/memory && \
    chown -R node:node /app/data

# Switch to non-root user
USER node

# Health check: verify process is running
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD node -e "process.exit(0)" || exit 1

# Start agent
CMD ["node", "dist/index.js"]
