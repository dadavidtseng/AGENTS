# ============================================================================
# Template Agent TypeScript - Test Environment
# ============================================================================
# Deploys standalone template-agent-typescript with ArcadeDB for testing
# Target: napoftheearth (64.23.168.129)
#
# Services:
# - arcadedb: Graph database for persistent memory
# - template-agent: Enhanced TypeScript agent with multi-LLM support
# ============================================================================

networks:
  agent-test-net:
    driver: bridge

volumes:
  arcadedb-data:
    driver: local
  agent-memory-data:
    driver: local

services:
  # ==========================================================================
  # ArcadeDB - Graph Database for Persistent Memory
  # ==========================================================================
  arcadedb:
    image: arcadedata/arcadedb:24.11.1
    container_name: template-agent-arcadedb
    restart: unless-stopped
    command: ["/bin/sh", "-c", "export JAVA_OPTS='-Xms256M -Xmx512M -Darcadedb.server.rootPassword=arcadedb' && /home/arcadedb/bin/server.sh"]
    ports:
      - "2480:2480"      # HTTP API
      - "2424:2424"      # Binary protocol
    volumes:
      - arcadedb-data:/home/arcadedb/databases
    networks:
      - agent-test-net
    environment:
      - JAVA_OPTS=-Xms256M -Xmx512M -Darcadedb.server.rootPassword=arcadedb
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:2480/api/v1/ready"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ==========================================================================
  # Template Agent TypeScript - Standalone Test Deployment
  # ==========================================================================
  template-agent:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: template-agent-test
    restart: unless-stopped
    depends_on:
      arcadedb:
        condition: service_healthy
    networks:
      - agent-test-net
    volumes:
      - agent-memory-data:/app/data/memory
    env_file:
      - .env.test
    environment:
      # Override environment variables for test deployment
      - NODE_ENV=production
      - MEMORY_DATA_PATH=/app/data/memory
      - ARCADEDB_URL=http://arcadedb:2480
      - NODE_TLS_REJECT_UNAUTHORIZED=0
    healthcheck:
      test: ["CMD", "node", "-e", "process.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
